<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kommentar Widget Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .blog-post {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        h1, h2 {
            color: #333;
        }
    </style>
</head>
<body>
    <div class="blog-post">
        <h1>Beispiel Blog-Post</h1>
        <p>Das ist ein Beispiel-Blog-Post, um zu zeigen, wie einfach das Kommentar-Widget eingebettet werden kann.</p>
        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>
        
        <h2>Kommentare</h2>
        <!-- Das ist alles was du in deinen Blog-Post einf√ºgen musst: -->
        <script>
            CommentWidget.init('mein-erster-blogpost', {
                apiUrl: 'http://localhost:8080/api/comments'
            });
        </script>
    </div>

    <!-- Das Kommentar-Widget Script (einmalig in deinem Template einbinden) -->
    <script>
        window.CommentWidget = (function() {
            let config = {
                apiUrl: 'http://localhost:8080/api/comments',
                theme: 'light'
            };

            // CSS f√ºr das Widget
            const widgetCSS = `
                .comment-widget {
                    margin: 20px 0;
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                }

                .comment-widget * {
                    box-sizing: border-box;
                }

                .comment-form {
                    background: #f8f9fa;
                    border: 1px solid #e9ecef;
                    border-radius: 8px;
                    padding: 20px;
                    margin-bottom: 30px;
                }

                .comment-form h3 {
                    margin: 0 0 20px 0;
                    color: #495057;
                    font-size: 1.2rem;
                }

                .comment-form-group {
                    margin-bottom: 15px;
                }

                .comment-form label {
                    display: block;
                    margin-bottom: 5px;
                    color: #495057;
                    font-weight: 500;
                }

                .comment-form input,
                .comment-form textarea {
                    width: 100%;
                    padding: 10px 12px;
                    border: 1px solid #ced4da;
                    border-radius: 4px;
                    font-size: 14px;
                    transition: border-color 0.15s ease-in-out;
                }

                .comment-form input:focus,
                .comment-form textarea:focus {
                    outline: none;
                    border-color: #007bff;
                    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
                }

                .comment-form textarea {
                    min-height: 100px;
                    resize: vertical;
                }

                .comment-submit-btn {
                    background: #007bff;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 14px;
                    transition: background-color 0.15s ease-in-out;
                }

                .comment-submit-btn:hover {
                    background: #0056b3;
                }

                .comment-submit-btn:disabled {
                    background: #6c757d;
                    cursor: not-allowed;
                }

                .comment-message {
                    padding: 10px 15px;
                    border-radius: 4px;
                    margin-bottom: 15px;
                    font-size: 14px;
                }

                .comment-message.success {
                    background: #d4edda;
                    border: 1px solid #c3e6cb;
                    color: #155724;
                }

                .comment-message.error {
                    background: #f8d7da;
                    border: 1px solid #f5c6cb;
                    color: #721c24;
                }

                .comments-list {
                    margin-top: 30px;
                }

                .comments-list h3 {
                    margin: 0 0 20px 0;
                    color: #495057;
                    font-size: 1.2rem;
                }

                .comment-item {
                    background: white;
                    border: 1px solid #e9ecef;
                    border-radius: 8px;
                    padding: 15px;
                    margin-bottom: 15px;
                }

                .comment-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 10px;
                    font-size: 13px;
                }

                .comment-author {
                    font-weight: 600;
                    color: #007bff;
                }

                .comment-date {
                    color: #6c757d;
                }

                .comment-text {
                    color: #495057;
                    line-height: 1.5;
                }

                .comments-loading {
                    text-align: center;
                    color: #6c757d;
                    padding: 20px;
                    font-style: italic;
                }

                .comments-empty {
                    text-align: center;
                    color: #6c757d;
                    padding: 20px;
                    background: #f8f9fa;
                    border-radius: 8px;
                    border: 1px dashed #dee2e6;
                }

                @media (max-width: 768px) {
                    .comment-form {
                        padding: 15px;
                    }
                    
                    .comment-header {
                        flex-direction: column;
                        align-items: flex-start;
                    }
                    
                    .comment-date {
                        margin-top: 5px;
                    }
                }
            `;

            // CSS einmalig hinzuf√ºgen
            function injectCSS() {
                if (!document.getElementById('comment-widget-styles')) {
                    const style = document.createElement('style');
                    style.id = 'comment-widget-styles';
                    style.textContent = widgetCSS;
                    document.head.appendChild(style);
                }
            }

            // HTML f√ºr das Widget generieren
            function createWidgetHTML(postId) {
                return `
                    <div class="comment-widget" data-post-id="${postId}">
                        <div class="comment-form">
                            <h3>üí¨ Kommentar schreiben</h3>
                            <div class="comment-message-container"></div>
                            <form class="comment-form-element">
                                <div class="comment-form-group">
                                    <label for="username-${postId}">Name *</label>
                                    <input type="text" id="username-${postId}" name="username" required>
                                </div>
                                <div class="comment-form-group">
                                    <label for="email-${postId}">E-Mail *</label>
                                    <input type="email" id="email-${postId}" name="mailaddress" required>
                                </div>
                                <div class="comment-form-group">
                                    <label for="text-${postId}">Kommentar *</label>
                                    <textarea id="text-${postId}" name="text" required placeholder="Schreibe hier deinen Kommentar..."></textarea>
                                </div>
                                <button type="submit" class="comment-submit-btn">Kommentar absenden</button>
                            </form>
                        </div>
                        <div class="comments-list">
                            <h3>üìù Kommentare</h3>
                            <div class="comments-container">
                                <div class="comments-loading">Kommentare werden geladen...</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Nachricht anzeigen
            function showMessage(container, message, type) {
                const messageContainer = container.querySelector('.comment-message-container');
                messageContainer.innerHTML = `<div class="comment-message ${type}">${message}</div>`;
                setTimeout(() => {
                    messageContainer.innerHTML = '';
                }, 5000);
            }

            // HTML escaping
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Kommentare laden
            async function loadComments(postId, container) {
                const commentsContainer = container.querySelector('.comments-container');
                
                try {
                    const response = await fetch(`${config.apiUrl}?post_id=${encodeURIComponent(postId)}`);
                    
                    if (response.ok) {
                        const comments = await response.json();
                        displayComments(comments, commentsContainer);
                    } else {
                        commentsContainer.innerHTML = '<div class="comments-loading">Fehler beim Laden der Kommentare</div>';
                    }
                } catch (error) {
                    console.error('Fehler beim Laden der Kommentare:', error);
                    commentsContainer.innerHTML = '<div class="comments-loading">Verbindungsfehler</div>';
                }
            }

            // Kommentare anzeigen
            function displayComments(comments, container) {
                if (!comments || comments.length === 0) {
                    container.innerHTML = '<div class="comments-empty">Noch keine Kommentare vorhanden. Sei der erste! üöÄ</div>';
                    return;
                }

                // Nach Datum sortieren (neueste zuerst)
                comments.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                const commentsHTML = comments.map(comment => {
                    const date = new Date(comment.created_at).toLocaleDateString('de-DE', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    return `
                        <div class="comment-item">
                            <div class="comment-header">
                                <span class="comment-author">${escapeHtml(comment.username)}</span>
                                <span class="comment-date">${date}</span>
                            </div>
                            <div class="comment-text">${escapeHtml(comment.text)}</div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = commentsHTML;
            }

            // Kommentar absenden
            async function submitComment(postId, formData, container) {
                const submitBtn = container.querySelector('.comment-submit-btn');
                const form = container.querySelector('.comment-form-element');
                
                submitBtn.disabled = true;
                submitBtn.textContent = 'Wird gesendet...';

                const commentData = {
                    post_id: postId,
                    username: formData.get('username'),
                    mailaddress: formData.get('mailaddress'),
                    text: formData.get('text')
                };

                try {
                    const response = await fetch(config.apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(commentData)
                    });

                    if (response.ok) {
                        showMessage(container, 'Kommentar erfolgreich erstellt! üéâ', 'success');
                        form.reset();
                        loadComments(postId, container);
                    } else {
                        const errorText = await response.text();
                        showMessage(container, `Fehler: ${errorText}`, 'error');
                    }
                } catch (error) {
                    console.error('Fehler beim Absenden:', error);
                    showMessage(container, 'Verbindungsfehler. Bitte versuche es sp√§ter erneut.', 'error');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Kommentar absenden';
                }
            }

            // Widget initialisieren
            function init(postId, options = {}) {
                // Konfiguration √ºberschreiben
                config = { ...config, ...options };
                
                // CSS injizieren
                injectCSS();

                // Widget HTML erstellen
                const widgetHTML = createWidgetHTML(postId);
                
                // Widget an der aktuellen Script-Position einf√ºgen
                const currentScript = document.currentScript;
                const container = document.createElement('div');
                container.innerHTML = widgetHTML;
                
                // Widget nach dem aktuellen Script einf√ºgen
                if (currentScript && currentScript.parentNode) {
                    currentScript.parentNode.insertBefore(container.firstElementChild, currentScript.nextSibling);
                } else {
                    // Fallback: Am Ende des body einf√ºgen
                    document.body.appendChild(container.firstElementChild);
                }

                // Event-Listener f√ºr das Formular
                const widget = document.querySelector(`[data-post-id="${postId}"]`);
                const form = widget.querySelector('.comment-form-element');
                
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(form);
                    await submitComment(postId, formData, widget);
                });

                // Kommentare initial laden
                loadComments(postId, widget);

                // Auto-refresh alle 60 Sekunden
                setInterval(() => {
                    loadComments(postId, widget);
                }, 60000);
            }

            // √ñffentliche API
            return {
                init: init,
                config: config
            };
        })();
    </script>
</body>
</html>